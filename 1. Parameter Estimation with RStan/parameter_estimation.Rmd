---
title: "Введение в RStan: Оценка параметров и диагностика результатов"
author: "Марина Дубова"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 9, message = FALSE)
```

```{r}
library(rstan)
library(ggmcmc) # для классных диагностических графичков
```

## Генерация данных

Нормальное распределение со средним, которое необходимо оценить, и стандартным отклонением 15

```{r}
set.seed(100)

N <- 500
true_mu <- 90
test_scores <- rnorm(N, true_mu, 15)
data_1 <- list(N = length(test_scores), X = test_scores) # формат данных для stan - список с переменными
```


### Составляющие блоки вероятностной модели в Stan

data{} - обязательный блок, в котором определяются переменные и их формат, которые модель ожидает получить на вход

transformed data{} - опциональный блок, в котором можно трансформировать полученные данные (например, центрировать, нормализовывать или логарифмировать)

parameters{} - обязательный блок для определения целевых параметров, которые будут оцениваться в модели

transformed parameters{} - опциональный блок, в котором можно лпределить дополнительные параметры, которые являются трансформированными целевыми

model{} - обязательный блок для определения априорных распределений параметров и функции правдоподобия

generated quantities{} - опциональный блок, в котором можно определить переменные, данные и статистики (ВСЁ), которые будут сгенерированы на основании оцененных параметров и сохранены в выходе модели

## Модель 1 

Необходимо оценить только среднее нормально распределенных данных

```{r}
model_1 <-
'
data {
  int<lower = 0> N;  // размер выборки (больше 0)
  vector[N] X; // наблюдения - вектор длины N
}

parameters {
  real<lower = 0> mu; // среднее нормального распределения, которое необходимо оценить
}

model {
  mu ~ normal(100, 25); // априорное распределение среднего
  X ~ normal(mu, 15); // функция правдоподобия
}
'
```

Типы переменных в stan: real, int, vector, row_vector, matrix, [etc](https://mc-stan.org/users/documentation/) 

Виды распределений в stan: normal, uniform, binomial, beta, cauchy, [etc](https://mc-stan.org/users/documentation/)

## Генерация апостериорного распределения

Необходимо использовать несколько цепей для диагностики результата

```{r, message = TRUE}
fit_1 <- stan(model_code = model_1, # код модели
              data = data_1, # список с данными для модели
              chains = 3, # количество цепей (со случайными изначальными точками), из которых генерируются апостериорные распределения
              iter = 5000, # количество сэмплирований из цепей
              warmup = 1000) # количество сэмплирований, после которого мы начинаем записывать результат
```

## Диагностика!!!

? Rhat == 1 - дисперсия значений внутри цепей и между цепями

? n_eff > 1000 - количество "успешных" сэмплов (с учетом автокорреляций)

Если нет - нужно увеличить количество итераций (iter) и warmup при генерации апостериорного распределения

```{r}
print(fit_1)
```

```{r}
plot(fit_1)
```

Результат - байесовский доверительный интервал для параметра

```{r}
posterior_mu <- ggs(fit_1) # считываем сэмплы в удобном для ggmcmc формате
ggmcmc(D = posterior_mu, file = NULL, plot = 'ggs_histogram') # апостериорное распределение параметра
mean(posterior_mu$value > 90) # какую часть апостериорного распределения составляют средние больше 90?
```

```{r}
ggmcmc(D = posterior_mu, file = NULL, plot = 'ggs_traceplot') # должен выглядить как белый шум, все цепи варьируют вокруг одинаковых значений. Если нет - можно попробовать увеличить warmup
```

Проверка схождения нескольких цепей к одинаковым значениям!

Пример плохого схождения:

![]("bad_trace.png")

```{r}
ggmcmc(D = posterior_mu, file = NULL, plot = 'ggs_compare_partial') # полное и частичное апостериорное распределение в идеале должны полностью перекрывать друг друга 
```

```{r}
ggmcmc(D = posterior_mu, file = NULL, plot = 'ggs_autocorrelation') # в идеале: все значения после 1 на нуле или очень близки к нулю
```

Пример "плохого" графика автокорреляции:

![]("bad_autocor.jpg")

Анализ чувствительности к априорному распределению: проверка получения того же результата с использованием разных априорных распределений. В противном случае, необходимо доказать необходимость использования выбранного распределения.


разные распределения!!! - bernoulli

## Модель 2

Необходимо оценить и среднее, и стандартное отклонение.

```{r}
model_2 <-
'
data {
  int<lower = 0> N;  // размер выборки (больше 0)
  vector[N] X; // наблюдения - вектор длины N
}

parameters {
  real<lower = 0> mu; // среднее нормального распределения, которое необходимо оценить
  real<lower = 0> sigma; // стандартное отклонение нормального распределения, которое необходимо оценить
}

model {
  mu ~ normal(100, 25); // априорное распределение среднего
  sigma ~ cauchy(0,3); // априорное распределение стандартного отклонения
  X ~ normal(mu, sigma); // функция правдоподобия
}
'
```


```{r}
fit_2 <- stan(model_code = model_2, data = data_1, chains = 3, iter = 5000, warmup = 1000)
```

```{r}
print(fit_2)
```

```{r}
posterior_fit_2 <- ggs(fit_2)
mean(posterior_fit_2$value > 90 & posterior_fit_2$Parameter == "mu")/mean(posterior_fit_2$Parameter == "mu")


ggmcmc(D = posterior_fit_2, file = NULL, plot = 'ggs_histogram')

# совместное апостериорное распределение

ggs_pairs(posterior_fit_2, lower = list(continuous = "density"))
```

## Диагностика

```{r}
ggmcmc(D = posterior_fit_2, file = NULL, plot = 'ggs_traceplot') 
ggmcmc(D = posterior_fit_2, file = NULL, plot = 'ggs_compare_partial') 
ggmcmc(D = posterior_fit_2, file = NULL, plot = 'ggs_autocorrelation')
```

